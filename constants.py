"""Identifiers for objects on the CAN bus(es) and physical robot dimensions.

Note: Swerve drivetrain configuration is now in generated/tuner_constants.py
which is designed to be regenerated by Phoenix Tuner X's Swerve Project Generator.
"""

from __future__ import annotations

import enum
from typing import Final

import wpilib
import wpimath.geometry as geo
import wpimath.units as units

# Associate alliances with the field-centric rotation that is forward.
ALLIANCE_PERSPECTIVE_ROTATION: dict[wpilib.DriverStation.Alliance, geo.Rotation2d] = {
    wpilib.DriverStation.Alliance.kBlue: geo.Rotation2d.fromDegrees(0),
    wpilib.DriverStation.Alliance.kRed: geo.Rotation2d.fromDegrees(180),
}


class CANID(enum.IntEnum):
    """IDs for items on the CAN bus.

    Note: Swerve motor and encoder CAN IDs are now in generated/tuner_constants.py.
    """

    # Other motors (non-swerve)
    SHOOTER_MOTOR = 15


# PWM port for the LED controller
LED_PWM_PORT: Final[int] = 9


class RobotDimension:
    """Physical dimensions and locations of robot components.

    Note: Swerve module locations are now in generated/tuner_constants.py.
    """

    # Shooter dimensions
    SHOOTER_Z: Final[units.meters] = 0.421
    SHOOTER_MAX_ANGLE: Final[units.radians] = units.degreesToRadians(34.0)


class ControllerPort:
    """USB ports for controllers."""

    DRIVER_CONTROLLER: Final[int] = 0
    OPERATOR_CONTROLLER: Final[int] = 1


class TeleopShift(enum.StrEnum):
    """Different shifts within the teleop period.

    Use TeleopShift.TRANSITION to refer to it by enum.
    Use TeleopShift.TRANSITION.startTime to get its start time in seconds.
    Use TeleopShift.TRANSITION.endTime to get its end time in seconds.
    """

    # fmt: off
    TRANSITION = ("transition", 140, 130)  # 2:20 – 2:10
    SHIFT1     = ("shift1",     130, 105)  # 2:10 – 1:45
    SHIFT2     = ("shift2",     105, 80)   # 1:45 – 1:20
    SHIFT3     = ("shift3",     80,  55)   # 1:20 – 0:55
    SHIFT4     = ("shift4",     55,  30)   # 0:55 – 0:30
    ENDGAME    = ("endgame",    30,   0)   # 0:30 – 0:00
    UNKNOWN    = ("-",          -1,  -1)   # Not in teleop
    # fmt: on

    # Declare extra attribute of the enum values.
    startTime: units.seconds
    endTime: units.seconds
    duration: units.seconds

    def __new__(cls, shiftName: str, startTime: units.seconds, endTime: units.seconds):
        """Create a new TeleopShift enum value from name, with start and end times."""
        obj = str.__new__(cls, shiftName)
        obj._value_ = shiftName
        obj.startTime = startTime
        obj.endTime = endTime
        obj.duration = startTime - endTime
        return obj

    @classmethod
    def byEndTime(cls) -> list[TeleopShift]:
        """Return all shifts sorted by end time, descending."""
        return sorted(cls, key=lambda s: s.endTime, reverse=True)


class PhaseDuration(enum.IntEnum):
    """Durations of different robot phases in seconds."""

    AUTONOMOUS = 15
    TELEOP = 140
    DISABLED = 0
    TEST = 0
