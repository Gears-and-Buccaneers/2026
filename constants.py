"""Identifiers for objects on the CAN bus(es) and physical robot dimensions.

Note: Swerve drivetrain configuration is now in generated/tuner_constants.py
which is designed to be regenerated by Phoenix Tuner X's Swerve Project Generator.
"""

from enum import IntEnum
from typing import Final

import wpilib
import wpimath.geometry as geom
import wpimath.units as units

# Associate alliances with the field-centric rotation that is forward.
ALLIANCE_PERSPECTIVE_ROTATION: dict[wpilib.DriverStation.Alliance, geom.Rotation2d] = {
    wpilib.DriverStation.Alliance.kBlue: geom.Rotation2d.fromDegrees(0),
    wpilib.DriverStation.Alliance.kRed: geom.Rotation2d.fromDegrees(180),
}


class CANID(IntEnum):
    """IDs for items on the CAN bus.

    Note: Swerve motor and encoder CAN IDs are now in generated/tuner_constants.py.
    """

    # Other motors (non-swerve)
    SHOOTER_MOTOR = 15


class RobotDimension:
    """Physical dimensions and locations of robot components.

    Note: Swerve module locations are now in generated/tuner_constants.py.
    """

    # Robot frame dimensions (without bumpers)
    WIDTH: Final[units.meters] = units.inchesToMeters(25.0)  # Side to side
    LENGTH: Final[units.meters] = units.inchesToMeters(30.0)  # Front to back

    # Shooter location relative to robot center (X=forward, Y=left, Z=up)
    # At lateral center, at front edge of robot frame, at shooter height
    SHOOTER_LOCATION: Final[geom.Translation3d] = geom.Translation3d(
        units.inchesToMeters(12.0),  # Inside the front edge (half of 30" length)
        0.0,  # Centered laterally on the robot.
        units.inchesToMeters(15.0),  # Height from ground of center of fuel when launched
    )

    SHOOTER_ANGLE: Final[units.radians] = units.degreesToRadians(65.0)

    # Flywheel radius for shooter
    FLYWHEEL_RADIUS: Final[units.meters] = units.inchesToMeters(4.0)


class ControllerPort:
    """USB ports for controllers."""

    DRIVER_CONTROLLER: Final[int] = 0
    OPERATOR_CONTROLLER: Final[int] = 1


class Field:
    """2026 Reefscape field dimensions.

    All measurements are in meters, with origin at the blue alliance corner.
    Field-centric coordinates: +X toward red alliance, +Y toward scoring table.
    """

    LENGTH: Final[units.meters] = units.inchesToMeters(651.22)
    WIDTH: Final[units.meters] = units.inchesToMeters(317.69)

    # Blue alliance hub position (top of funnel opening)
    # Use alliance mirroring for red alliance
    HUB_CENTER_X: Final[units.meters] = units.inchesToMeters(182.11)  # from blue wall
    HUB_CENTER_Y: Final[units.meters] = WIDTH / 2  # Centered on field
    HUB_TOP_Z: Final[units.meters] = units.inchesToMeters(72.0)  # funnel top height
    HUB_TARGET_Z: Final[units.meters] = units.inchesToMeters(58.0)  # mid-funnel for reliable scoring

    # Funnel geometry (hexagon with point toward alliances)
    HUB_FUNNEL_WIDTH: Final[units.meters] = units.inchesToMeters(41.932)  # across flats

    # Game piece
    FUEL_DIAMETER: Final[units.meters] = units.inchesToMeters(5.9)

    @staticmethod
    def getHubPosition(alliance: wpilib.DriverStation.Alliance | None) -> geom.Translation2d:
        """Get the hub position for the given alliance.

        Args:
            alliance: The alliance (blue or red). If None, defaults to blue.

        Returns:
            Translation2d of the hub center position in field coordinates.
        """
        if alliance == wpilib.DriverStation.Alliance.kRed:
            # Mirror X position for red alliance
            return geom.Translation2d(Field.LENGTH - Field.HUB_CENTER_X, Field.HUB_CENTER_Y)
        else:
            return geom.Translation2d(Field.HUB_CENTER_X, Field.HUB_CENTER_Y)


class Simulation:
    """Constants for simulation behavior."""

    # Flywheel physics
    FLYWHEEL_SPINUP_TIME: Final[units.seconds] = 1.0  # Time to reach full speed
    FLYWHEEL_SLOWDOWN_PER_SHOT: Final[float] = 1.0  # 0% reduction per shot
    # FLYWHEEL_SLOWDOWN_PER_SHOT: Final[float] = 0.98  # 2% reduction per shot

    # Time between fuel launches (uniform random distribution)
    FUEL_EMIT_INTERVAL_MIN: Final[units.seconds] = 0.05
    FUEL_EMIT_INTERVAL_MAX: Final[units.seconds] = 0.05
    # FUEL_EMIT_INTERVAL_MIN: Final[units.seconds] = 0.1
    # FUEL_EMIT_INTERVAL_MAX: Final[units.seconds] = 0.5

    # Launch speed variation (±percentage of target speed)
    LAUNCH_SPEED_VARIATION: Final[float] = 0.0  # ±0%
    # LAUNCH_SPEED_VARIATION: Final[float] = 0.02  # ±2%

    # Launch angle variation (random offset from ideal trajectory)
    LAUNCH_YAW_VARIATION: Final[units.radians] = units.degreesToRadians(0.0)  # ±0° left/right
    LAUNCH_PITCH_VARIATION: Final[units.radians] = units.degreesToRadians(0.0)  # ±0° up/down
    # LAUNCH_YAW_VARIATION: Final[units.radians] = units.degreesToRadians(2.0)  # ±2° left/right
    # LAUNCH_PITCH_VARIATION: Final[units.radians] = units.degreesToRadians(1.0)  # ±1° up/down

    # Fuel bounce physics
    FUEL_BOUNCE_VELOCITY_RETENTION: Final[float] = 0.5  # Keep 60% of velocity on bounce
    FUEL_MAX_BOUNCES: Final[int] = 5  # Remove fuel after this many bounces

    # G is 9.795 in Boulder/Denver, 9.80 in West Valley City, UT
    GRAVITY: Final[units.meters_per_second_squared] = 9.80
